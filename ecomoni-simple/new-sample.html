<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nouvel √âchantillon - EcoMonitoring</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåç</text></svg>">
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">EcoMonitoring</div>
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button>
            <nav id="mobile-nav">
                <ul>
                    <li><a href="index.html">Accueil</a></li>
                    <li><a href="map.html">Carte</a></li>
                    <li><a href="new-sample.html" class="active">Nouvel √âchantillon</a></li>
                    <li><a href="alerts.html">Alertes</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <div class="card">
            <h1>üìä Nouvel √âchantillon</h1>
            <p>Enregistrez un nouvel √©chantillon environnemental avec g√©olocalisation et comparaison automatique aux normes.</p>
        </div>

        <!-- Formulaire d'ajout -->
        <div class="card">
            <h2>‚ûï Ajouter un √âchantillon</h2>
            <form id="sample-form">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                    <div>
                        <div class="form-group">
                            <label for="parametre">Param√®tre *</label>
                            <select id="parametre" class="form-control" required onchange="mettreAJourUnite()">
                                <option value="">S√©lectionner un param√®tre</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="valeur">Valeur *</label>
                            <input type="number" id="valeur" class="form-control" step="0.000001" required placeholder="Ex: 0.015">
                        </div>

                        <div class="form-group">
                            <label for="unite">Unit√© *</label>
                            <input type="text" id="unite" class="form-control" readonly>
                        </div>

                        <div class="form-group">
                            <label for="type">Type *</label>
                            <input type="text" id="type" class="form-control" readonly>
                        </div>

                        <div class="form-group">
                            <label for="libelle">Libell√© *</label>
                            <input type="text" id="libelle" class="form-control" required placeholder="Ex: Station de mesure principale">
                        </div>
                    </div>

                    <div>
                        <div class="form-group">
                            <label for="latitude">Latitude *</label>
                            <input type="number" id="latitude" class="form-control" step="0.000001" required placeholder="Ex: 14.6928">
                            <div class="location-buttons">
                                <button type="button" onclick="obtenirLocalisationActuelle()" class="btn btn-small">
                                    üìç Localiser
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="longitude">Longitude *</label>
                            <input type="number" id="longitude" class="form-control" step="0.000001" required placeholder="Ex: -17.4467">
                            <div class="location-buttons">
                                <button type="button" onclick="obtenirLocalisationActuelle()" class="btn btn-small">
                                    üìç Localiser
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="adresse">Adresse (optionnel)</label>
                            <input type="text" id="adresse" class="form-control" placeholder="Ex: Dakar, S√©n√©gal" readonly>
                        </div>

                        <div class="form-group">
                            <label for="commentaires">Commentaires</label>
                            <textarea id="commentaires" class="form-control" rows="3" placeholder="Commentaires optionnels..."></textarea>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 2rem; text-align: center;">
                    <button type="submit" class="btn">Enregistrer l'√âchantillon</button>
                    <button type="button" onclick="reinitialiserFormulaire()" class="btn btn-secondary">R√©initialiser</button>
                </div>
            </form>
        </div>

        <!-- Aper√ßu des normes -->
        <div class="card" id="normes-preview" style="display: none;">
            <h2>üìã Comparaison aux Normes</h2>
            <div id="normes-content"></div>
        </div>

        <!-- Import/Export -->
        <div class="card">
            <h2>üìÅ Import/Export des Donn√©es</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                <div>
                    <h3>üì§ Exporter</h3>
                    <p>Exportez toutes vos mesures dans diff√©rents formats.</p>
                    <div style="margin-top: 1rem;">
                        <button onclick="exporterEchantillons('csv')" class="btn btn-success">Export CSV</button>
                        <button onclick="exporterEchantillons('json')" class="btn btn-success">Export JSON</button>
                    </div>
                </div>

                <div>
                    <h3>üì• Importer</h3>
                    <p>Importez des fichiers CSV ou JSON pour ajouter des mesures.</p>
                    <div style="margin-top: 1rem;">
                        <input type="file" id="import-file" accept=".csv,.json" style="margin-bottom: 1rem;">
                        <button onclick="importerFichier()" class="btn btn-warning">Importer</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistiques r√©centes -->
        <div class="card">
            <h2>üìà Statistiques R√©centes</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-echantillons">0</div>
                    <div class="stat-label">Total √âchantillons</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="echantillons-aujourdhui">0</div>
                    <div class="stat-label">Aujourd'hui</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="alertes-generes">0</div>
                    <div class="stat-label">Alertes G√©n√©r√©es</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="derniere-ajout">-</div>
                    <div class="stat-label">Dernier Ajout</div>
                </div>
            </div>
        </div>

        <!-- Derniers √©chantillons -->
        <div class="card">
            <h2>üìã Derniers √âchantillons</h2>
            <div id="derniers-echantillons">
                <p>Chargement...</p>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 EcoMonitoring - Surveillance Environnementale. Tous droits r√©serv√©s.</p>
    </footer>

    <script src="standards.js"></script>
    <script src="script.js"></script>
    <script>
        // Initialiser le formulaire au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            initialiserFormulaire();
            chargerStatistiques();
            chargerDerniersEchantillons();
            initialiserMenuMobile();
        });

        // Fonction pour le menu mobile
        function toggleMobileMenu() {
            const nav = document.getElementById('mobile-nav');
            nav.classList.toggle('active');
        }

        function initialiserMenuMobile() {
            const navLinks = document.querySelectorAll('#mobile-nav a');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    const nav = document.getElementById('mobile-nav');
                    nav.classList.remove('active');
                });
            });
        }

        function initialiserFormulaire() {
            // Charger les param√®tres dans le select
            const parametreSelect = document.getElementById('parametre');
            STANDARDS.forEach(standard => {
                const option = document.createElement('option');
                option.value = standard.parametre;
                option.textContent = `${standard.parametre} (${standard.type})`;
                parametreSelect.appendChild(option);
            });

            // G√©rer la soumission du formulaire
            document.getElementById('sample-form').addEventListener('submit', function(e) {
                e.preventDefault();
                ajouterEchantillonForm();
            });

            // Mettre √† jour l'aper√ßu des normes quand la valeur change
            document.getElementById('valeur').addEventListener('input', function() {
                mettreAJourApercuNormes();
            });

            // Essayer d'obtenir la localisation automatiquement au chargement
            obtenirLocalisationActuelle();
        }

        function obtenirLocalisationActuelle() {
            const latitudeInput = document.getElementById('latitude');
            const longitudeInput = document.getElementById('longitude');
            const adresseInput = document.getElementById('adresse');
            
            // Afficher un indicateur de chargement
            const boutons = document.querySelectorAll('button[onclick="obtenirLocalisationActuelle()"]');
            boutons.forEach(btn => {
                btn.innerHTML = '‚è≥ Localisation...';
                btn.disabled = true;
            });

            if (!navigator.geolocation) {
                alert('La g√©olocalisation n\'est pas support√©e par ce navigateur.');
                reinitialiserBoutonsLocalisation();
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    latitudeInput.value = lat.toFixed(6);
                    longitudeInput.value = lng.toFixed(6);
                    
                    // Obtenir l'adresse via g√©ocodage invers√©
                    obtenirAdresseFromCoords(lat, lng, adresseInput);
                    
                    reinitialiserBoutonsLocalisation();
                    
                    // Afficher un message de succ√®s
                    afficherMessage('‚úÖ Localisation obtenue avec succ√®s !', 'success');
                },
                function(error) {
                    let message = 'Erreur lors de la g√©olocalisation: ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message += 'Permission refus√©e. Veuillez autoriser la g√©olocalisation.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message += 'Position non disponible.';
                            break;
                        case error.TIMEOUT:
                            message += 'D√©lai d\'attente d√©pass√©.';
                            break;
                        default:
                            message += 'Erreur inconnue.';
                            break;
                    }
                    
                    alert(message);
                    reinitialiserBoutonsLocalisation();
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000 // 5 minutes
                }
            );
        }

        function reinitialiserBoutonsLocalisation() {
            const boutons = document.querySelectorAll('button[onclick="obtenirLocalisationActuelle()"]');
            boutons.forEach(btn => {
                btn.innerHTML = 'üìç Localiser';
                btn.disabled = false;
            });
        }

        function obtenirAdresseFromCoords(lat, lng, adresseInput) {
            // Utiliser l'API de g√©ocodage invers√© d'OpenStreetMap (Nominatim)
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.display_name) {
                        adresseInput.value = data.display_name;
                    }
                })
                .catch(error => {
                    console.log('Erreur lors de la r√©cup√©ration de l\'adresse:', error);
                    adresseInput.value = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                });
        }

        function afficherMessage(message, type = 'info') {
            // Cr√©er un √©l√©ment de message temporaire
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease-out;
            `;
            
            switch(type) {
                case 'success':
                    messageDiv.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                    break;
                case 'error':
                    messageDiv.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
                    break;
                case 'warning':
                    messageDiv.style.background = 'linear-gradient(135deg, #ffc107, #fd7e14)';
                    break;
                default:
                    messageDiv.style.background = 'linear-gradient(135deg, #1e3c72, #2a5298)';
            }
            
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            // Supprimer le message apr√®s 3 secondes
            setTimeout(() => {
                messageDiv.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }, 3000);
        }

        function mettreAJourUnite() {
            const parametre = document.getElementById('parametre').value;
            const standard = getStandardsForParameter(parametre);
            
            if (standard) {
                document.getElementById('unite').value = standard.unite;
                document.getElementById('type').value = standard.type;
                mettreAJourApercuNormes();
            } else {
                document.getElementById('unite').value = '';
                document.getElementById('type').value = '';
                document.getElementById('normes-preview').style.display = 'none';
            }
        }

        function mettreAJourApercuNormes() {
            const parametre = document.getElementById('parametre').value;
            const valeur = parseFloat(document.getElementById('valeur').value);
            
            if (!parametre || isNaN(valeur)) {
                document.getElementById('normes-preview').style.display = 'none';
                return;
            }

            const sample = {
                parametre: parametre,
                valeur: valeur.toString(),
                unite: document.getElementById('unite').value
            };

            const resultats = comparerAuxNormes(sample);
            
            if (resultats.error) {
                document.getElementById('normes-preview').style.display = 'none';
                return;
            }

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">';
            
            Object.keys(resultats).forEach(norme => {
                const resultat = resultats[norme];
                const depassement = resultat.depassement;
                const icone = depassement ? 'üî¥' : '‚úÖ';
                const couleur = depassement ? '#dc3545' : '#28a745';
                const statut = depassement ? 'D√©passement' : 'Conforme';
                
                html += `
                    <div style="padding: 1rem; border-radius: 5px; border-left: 4px solid ${couleur}; background: ${depassement ? '#f8d7da' : '#d4edda'};">
                        <h4 style="margin: 0 0 0.5rem 0; color: ${couleur};">${icone} ${norme}</h4>
                        <p style="margin: 0; font-size: 0.9rem;">
                            <strong>Seuil:</strong> ${resultat.seuil} ${sample.unite}<br>
                            <strong>Statut:</strong> ${statut}<br>
                            <strong>Ratio:</strong> ${resultat.ratio.toFixed(2)}x
                        </p>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('normes-content').innerHTML = html;
            document.getElementById('normes-preview').style.display = 'block';
        }

        function ajouterEchantillonForm() {
            const formData = {
                parametre: document.getElementById('parametre').value,
                valeur: document.getElementById('valeur').value,
                unite: document.getElementById('unite').value,
                type: document.getElementById('type').value,
                libelle: document.getElementById('libelle').value,
                latitude: parseFloat(document.getElementById('latitude').value),
                longitude: parseFloat(document.getElementById('longitude').value),
                commentaires: document.getElementById('commentaires').value
            };

            // Validation
            if (!formData.parametre || !formData.valeur || !formData.libelle || !formData.latitude || !formData.longitude) {
                afficherMessage('Veuillez remplir tous les champs obligatoires.', 'error');
                return;
            }

            const resultat = ajouterEchantillon(formData);
            
            if (resultat.success) {
                afficherMessage('√âchantillon ajout√© avec succ√®s !', 'success');
                reinitialiserFormulaire();
                chargerStatistiques();
                chargerDerniersEchantillons();
                
                // Recharger la carte si elle est ouverte
                if (typeof afficherCarte === 'function') {
                    setTimeout(() => {
                        afficherCarte();
                    }, 500);
                }
            } else {
                afficherMessage('Erreur: ' + resultat.message, 'error');
            }
        }

        function reinitialiserFormulaire() {
            document.getElementById('sample-form').reset();
            document.getElementById('normes-preview').style.display = 'none';
        }

        function importerFichier() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Veuillez s√©lectionner un fichier √† importer.');
                return;
            }

            importerEchantillons(file)
                .then(resultat => {
                    alert(`Import termin√© !\nAjout√©s: ${resultat.ajoutes}\nErreurs: ${resultat.erreurs}\nTotal: ${resultat.total}`);
                    chargerStatistiques();
                    chargerDerniersEchantillons();
                    fileInput.value = '';
                })
                .catch(error => {
                    alert('Erreur lors de l\'import: ' + error.message);
                });
        }

        function chargerStatistiques() {
            const echantillons = chargerEchantillons();
            const alertes = chargerAlertes();
            
            document.getElementById('total-echantillons').textContent = echantillons.length;
            
            // √âchantillons d'aujourd'hui
            const aujourdhui = new Date().toDateString();
            const echantillonsAujourdhui = echantillons.filter(e => 
                new Date(e.date).toDateString() === aujourdhui
            ).length;
            document.getElementById('echantillons-aujourdhui').textContent = echantillonsAujourdhui;
            
            document.getElementById('alertes-generes').textContent = alertes.length;
            
            // Dernier ajout
            if (echantillons.length > 0) {
                const dernier = echantillons.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                const heures = Math.floor((new Date() - new Date(dernier.date)) / (1000 * 60 * 60));
                document.getElementById('derniere-ajout').textContent = `${heures}h`;
            } else {
                document.getElementById('derniere-ajout').textContent = '-';
            }
        }

        function chargerDerniersEchantillons() {
            const echantillons = chargerEchantillons()
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 10);
            
            const container = document.getElementById('derniers-echantillons');
            
            if (echantillons.length === 0) {
                container.innerHTML = '<p>Aucun √©chantillon enregistr√©.</p>';
                return;
            }
            
            let html = '<div class="table-container"><table><thead><tr><th>Param√®tre</th><th>Valeur</th><th>Type</th><th>Date</th><th>Statut</th></tr></thead><tbody>';
            
            echantillons.forEach(echantillon => {
                const alertes = chargerAlertes().filter(a => a.echantillonId === echantillon.id);
                let statut = '‚úÖ Conforme';
                let classe = 'conforme';
                
                if (alertes.length > 0) {
                    const gravites = alertes.map(a => a.gravite);
                    if (gravites.includes('critique')) {
                        statut = 'üî¥ Critique';
                        classe = 'critique';
                    } else if (gravites.includes('avertissement')) {
                        statut = 'üü† Avertissement';
                        classe = 'avertissement';
                    }
                }
                
                html += `
                    <tr class="${classe}">
                        <td>${echantillon.parametre}</td>
                        <td>${echantillon.valeur} ${echantillon.unite}</td>
                        <td>${echantillon.type}</td>
                        <td>${formaterDate(echantillon.date)}</td>
                        <td><span class="gravite ${classe}">${statut}</span></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
    </script>
</body>
</html>
